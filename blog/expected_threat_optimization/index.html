<!doctype html><html lang=en-us><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-131142568-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","UA-131142568-1")</script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.js></script><meta charset=utf-8><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta name=viewport content="width=device-width,initial-scale=1"><title>Using Optimization Modeling for Expected Threat - AlpsCode</title><meta name=author content="Sertalp B. Cay"><meta name=keywords content="analytics,programming,optimization,sports,soccer"><meta name=description content><meta name=generator content="Hugo 0.147.8"><link href='//fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,500,700,800' rel=stylesheet type=text/css><link rel=stylesheet href=//use.fontawesome.com/releases/v5.11.2/css/all.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css integrity=sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u crossorigin=anonymous><link href=/css/animate.css rel=stylesheet><link href=/css/style.default.css rel=stylesheet id=theme-stylesheet><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel="shortcut icon" href=/img/favicon.ico type=image/x-icon><link rel=apple-touch-icon href=/img/apple-touch-icon.png><link href=/css/owl.carousel.css rel=stylesheet><link href=/css/owl.theme.css rel=stylesheet><link rel=alternate href=https://alpscode.com/index.xml type=application/rss+xml title=AlpsCode><meta property="og:locale" content="en_us"><meta property="og:site_name" content="AlpsCode"><meta property="og:title" content="Using Optimization Modeling for Expected Threat"><meta property="og:type" content="article"><meta property="og:url" content="https://alpscode.com/blog/expected_threat_optimization/"><meta property="og:description" content><meta property="og:image" content="https://alpscode.com/img/banners/pexels-kevin-ku-577585.jpg"><meta property="og:image:type" content="image/jpg"><meta property="og:image:width" content="640"><meta property="og:image:height" content="479"><meta property="og:updated_time" content="2021-03-24T21:00:00-0500"><meta property="article:section" content="Optimization"><meta property="article:tag" content="sports"><meta property="article:tag" content="analytics"><meta property="article:tag" content="soccer"><meta property="article:tag" content="optimization"><meta property="article:published_time" content="2021-03-24T21:00:00-0500"><meta property="article:modified_time" content="2021-03-24T21:00:00-0500"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Using Optimization Modeling for Expected Threat"><meta name=twitter:image content="https://alpscode.com/img/banners/pexels-kevin-ku-577585.jpg"><meta name=twitter:description content><script type=text/javascript>var _paq=_paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){t="//alpscode.com/piwik/",_paq.push(["setTrackerUrl",t+"piwik.php"]),_paq.push(["setSiteId","1"]);var t,n=document,e=n.createElement("script"),s=n.getElementsByTagName("script")[0];e.type="text/javascript",e.async=!0,e.defer=!0,e.src=t+"piwik.js",s.parentNode.insertBefore(e,s)}()</script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload@10.19.0/dist/lazyload.min.js></script><link href=/css/syntax.css rel=stylesheet><link href=/css/custom.css rel=stylesheet><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script>MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]]}}</script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script></head><body><div id=all><header><header class=navbar-affixed-top data-spy=affix data-offset-top=62><div class="navbar navbar-default yamm" role=navigation id=navbar><div class=container><div class=navbar-header><a class="navbar-brand home" href=/><img src=/img/logo.svg alt="Using Optimization Modeling for Expected Threat logo" class="hidden-xs hidden-sm">
<img src=/img/logo.svg alt="Using Optimization Modeling for Expected Threat logo" class="visible-xs visible-sm">
<span class=sr-only>Using Optimization Modeling for Expected Threat - go to homepage</span></a><div class=navbar-buttons><button type=button class="navbar-toggle btn-template-main" data-toggle=collapse data-target=#navigation>
<span class=sr-only>Toggle Navigation</span>
<i class="fas fa-align-justify"></i></button></div></div><div class="navbar-collapse collapse" id=navigation><ul class="nav navbar-nav navbar-right"><li class="dropdown active"><a href=/blog/>Blog</a></li><li class=dropdown><a href=/about>About</a></li></ul></div><div class="collapse clearfix" id=search><form class=navbar-form role=search><div class=input-group><input type=text class=form-control placeholder=Search>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div></div></header></header><div id=heading-breadcrumbs><div class=container><div class=row><div class=col-md-12><h1>Using Optimization Modeling for Expected Threat</h1></div></div></div></div><div id=content><div class=container><div class=row><div class=col-md-9 id=blog-post><p class="text-muted mb-small text-right">By <a href=/about>Sertalp B. Cay</a> | March 24, 2021</p><div class=post-header-img style=background-image:url(https://alpscode.com/img/banners/pexels-kevin-ku-577585.jpg)><div class=post-header-img-inner></div></div><div id=post-content><p>If you know little about football analytics, I can safely assume that you have heard of expected goals (xG).
For those who don&rsquo;t know, xG is a metric showing the probability of a shot to be successful with the information we have, such as position, body part, and defender positions.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>
Another of such metrics is expected assists (xA) which can measure the probability that a pass leads to a goal.</p><p>A while ago, Karun Singh wrote a blog post and introduced <a href=https://karun.in/blog/expected-threat.html target=_blank>expected threat (xT)</a> which measures the offensive contribution of any non-shot action (pass, dribble, cross).<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>
The main idea revolves around <strong>rewarding individual player actions</strong> on how much they contribute offensively using probabilistic outcomes.
If a player sends a cross into the box, for example, how much it increases the change of a goal.
Such measures play a critical role in evaluation player performances even if the outcome of the attack is not successful.</p><p>Most recently, Abhishek Sharma implemented the $\mathrm{xT}$ idea in Julia and <a href=https://sharmaabhishekk.github.io/projects/xt-derivation-julia target=_blank>shared a Jupyter notebook and data</a> for the analysis.
For a while I was looking for a way to bring optimization lens into the mix and finally noticed a nice opportunity.</p><p>Before I go into the optimization part, let me start with reviewing the basic idea.</p><h2 id=xt-idea-and-solution-approach>xT Idea and Solution Approach</h2><p>Suppose we have created a 16 by 12 grid representing the field as follows <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>:</p><script>initial_data=[{name:"Grealish",action:"pass",from:[77.07,33.38],to:[92.75,22.91],bins:[[11,5],[14,4]]},{name:"James",action:"pass",from:[74.65,22.1],to:[93.24,10.94],bins:[[11,3],[14,1]]},{name:"Mané",action:"dribble",from:[89.67,60.79],to:[100.38,47.46],bins:[[13,10],[15,8]]},{name:"Gündogan",action:"cross",from:[97.86,58.072],to:[96.7,27.47],bins:[[14,10],[14,4]]},{name:"Zaha",action:"dribble",from:[90.4,9.52],to:[95.34,18.63],bins:[[13,1],[14,3]]},{name:"Lindelöf",action:"pass",from:[32.44,5.57],to:[98.28,26.79],bins:[[4,0],[14,4]]},{name:"Traoré",action:"pass",from:[78.54,37.74],to:[91.98,46.98],bins:[[11,6],[14,8]]},{name:"Calvert-Lewin",action:"pass",from:[78.64,6.05],to:[104.16,9.38],bins:[[11,1],[15,1]]},{name:"Willian",action:"shot",from:[80.745,30.736],to:[105,36.516],bins:[[12,5],[15,6]]},{name:"Fernandes",action:"shot",from:[77.595,42.5],to:[105,35.904],bins:[[11,7],[15,6]]}]</script><div id=initial_visual class=row><div id=initial_field class="col-12 col-md-8"></div><div id=initial_table class="col-12 col-md-4"><table class="table table-sm table-hover" id=table1><thead><tr><th>Name</th><th>Action</th><th>From</th><th>To</th></tr></thead><tbody></tbody><caption style=caption-side:bottom>Sample actions from 2019/20 data. Click/hover on action to see on the pitch.</caption></table></div></div><script type=text/javascript>Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{value:function(e=1){return this.reduce(function(t,n){return t.concat(Array.isArray(n)&&e>1?n.flat(e-1):n)},[])}}),initial_data.forEach(e=>{$("#table1 tbody").append(`<tr style="cursor: pointer" data-from="${e.from}" data-to="${e.to}" class="table1-row"><td>${e.name}</td><td>${e.action}</td><td>${e.bins[0]}</td><td>${e.bins[1]}</td></tr>`)}),$(document).on("mouseover",".table1-row",function(e){let t=e.currentTarget.dataset.from.split(",").map(e=>parseFloat(e)),n=e.currentTarget.dataset.to.split(",").map(e=>parseFloat(e));addLine(t,n)})</script><script src=/js/field.js></script><script type=text/javascript>$(document).ready(function(){const h=500,m=360,e={top:0,right:0,bottom:0,left:0},b=h-e.left-e.right,v=m-e.top-e.bottom,t=d3.select("#initial_field").append("svg").attr("viewBox",`0 0  ${b+e.left+e.right} ${v+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");t.append("rect").attr("fill","#f1f1f1").attr("width",h).attr("height",m);const f=t.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(f,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const y="#6b6b6b",d=f.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),u=16,n=12,i=1050/u,o=680/n,p=[];for(var s,a,r,l,g,j,c=0;c<u;c++){let e=[];for(s=0;s<n;s++)e.push([c,s]);p.push(e)}l=d.selectAll().data(p).enter().append("g").attr("class","row"),a=(e)=>{let n=d3.select(e.target);n.style("fill","#82f1ff")},g=(e)=>{let n=d3.select(e.target);n.style("fill","#00000000")},j=l.selectAll().data(function(e){return e}).enter().append("rect").attr("class","square").attr("x",function(e){return e[0]*i}).attr("y",function(e){return(n-e[1]-1)*o}).attr("width",i).attr("height",o).style("fill","#00000000").style("stroke",y).attr("stroke-width",.3).on("mouseover",a).on("mousemove",a).on("mouseleave",g),l.selectAll().data(function(e){return e}).enter().append("text").attr("x",function(e){return e[0]*i+i/2}).attr("y",function(e){return(n-e[1]-1)*o+o/2}).attr("alignment-baseline","middle").attr("text-anchor","middle").attr("font-size","15pt").style("text-shadow","0px 0px 2px gray").text(function(e){return e[0]+","+e[1]}).style("pointer-events","none"),arrowPoints=[[0,0],[0,20],[20,10]],r=t.append("defs"),r.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),r.append("marker").attr("id","redarrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","red").attr("fill","red"),t.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),t.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),window.addLine=(e,n)=>{d3.select("#action_line").remove(),console.log(t),d.append("line").attr("id","action_line").attr("x1",e[0]*10).attr("y1",680-e[1]*10).attr("x2",n[0]*10).attr("y2",680-n[1]*10).attr("stroke-width",4).attr("stroke","red").attr("marker-end","url(#redarrow)").attr("fill","none")}})</script><p>I will use letter $G$ to represent set of all grid pairs in this representation.</p><p>Calculating the expected threat consists of two parts:</p><p>$$
\mathrm{xT}_{x,y} = \underbrace{s_{x,y} \cdot g_{x,y}}_{\text{shot threat}} + \underbrace{m_{x,y} \cdot \sum_{(z,w) \in G} T_{(x,y)\to (z,w)} \cdot \mathrm{xT}_{z,w} }_{\text{move threat}}
$$</p><p>This equation defines expected threat at grid $(x,y)$ as the sum of all possible actions and their contribution to scoring probability.
By having this nested structure<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>, and we are calculating the threat based on steady-state.<sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup></p><p>Let me go over each term in here:</p><ul><li>$\mathrm{xT}_{x,y}$ is the expected threat of having the ball in grid position $x,y$ (possession value), where $x$ and $y$ are x-axis and y-axis grid numbers, respectively.</li><li>$s_{x,y}$ is the historical percentage of taking a shot at grid position $x,y$.</li><li>$g_{x,y}$ is the probability of scoring if a shot is taken at grid location $x,y$.
We are not differentiating what kind of shot it is, but details can be added based on available data; but think this as an oversimplified xG.</li><li>$m_{x,y}$ is the historical percentage of moving the ball.
This is the counterpart of $s_{x,y}$ so we assume $s_{x,y} + m_{x,y} = 1$.</li><li>Finally, we have the transition matrix $T$ that represents the historical percentage of moving ball from grid $x,y$ to $z,w$ successfully, denoted by $T_{(x,y) \to (z,w)}$.</li></ul><p>Karun originally proposed solving these equations using an iterative approach: set $\mathrm{xT}$ to 0 initially, calculate all corresponding values, and repeat until convergence.
Since we have $16 \times 12 = 192$ variables and $192$ equalities, it is actually a linear system of equations in the form of:
$$
Ax = b
$$
where $b$ is the vector of constants coming from shot threat and matrix $A$ is produced by move threat and $\mathrm{xT}$ multipliers.
Assuming this is a full-rank matrix, solving this system is as easy as calling <code>A\b</code> in MATLAB.</p><h2 id=base-model-for-xt>Base Model for xT</h2><p>Even though it is an overkill to use optimization modeling to solve the base problem, I would like to do it before moving to the next step.
Essentially, the whole thing can be written as</p><p class=x-scroll>\begin{align}
\textrm{minimize: } \; & 0 \\
\text{subject to: } \;
& \mathrm{xT}_{x,y} = s_{x,y} \cdot g_{x,y} + m_{x,y} \cdot \sum_{(z,w) \in G} T_{(x,y)\to (z,w)} \cdot \mathrm{xT}_{z,w} \quad \forall (x,y) \in G
\end{align}</p><p>As you see, we don&rsquo;t really need an objective function as this is a feasibility problem.
There is a unique solution that satisfies all these constraints at the same time, and we reach it once we solve the problem.
The model can be written using <em>sasoptpy</em> in Python and can be solved with <em>CBC</em> solver as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>model <span style=color:#f92672>=</span> so<span style=color:#f92672>.</span>Model(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xThreatModel&#39;</span>)
</span></span><span style=display:flex><span>indices <span style=color:#f92672>=</span> [(x,y) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(w) <span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(l)]
</span></span><span style=display:flex><span>xT <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xT&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>==</span> shots<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> scores<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>+</span> moves<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> so<span style=color:#f92672>.</span>expr_sum(T<span style=color:#f92672>.</span>loc[(x,y),(z,w)] <span style=color:#f92672>*</span> xT[z,w] <span style=color:#66d9ef>for</span> (z,w) <span style=color:#f92672>in</span> indices) <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;relation&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>set_objective(<span style=color:#ae81ff>0</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;zero&#39;</span>, sense<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;N&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>export_mps(filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;export.mps&#39;</span>)
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cbc export.mps solve solu solution.txt&#39;</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>system(command)
</span></span></code></pre></div><p>I used the data Abhishke shared (entire 2019-2020 EPL data) and solved the problem to get expected threat values.
Hover/click over the pitch below to display expected threat values and where the threat is getting generated from.
Remember, $\mathrm{xT}$ consists of move and shot threat values.</p><div id=model1 class=row><div id=model1_field class="col-12 col-md-8"></div><div id=model1_info class="col-12 col-md-4"><table class="table table-sm table-hover" id=model1_table style=table-layout:fixed><thead><tr><th></th><th>Value</th></tr></thead><tbody><tr><td>Grid</td><td id=m1_grid_no>-</td></tr><tr><td>xT</td><td id=m1_xT>-%</td></tr><tr><td>Move Threat</td><td id=m1_mT>-%</td></tr><tr><td>Shot Threat</td><td id=m1_sT>-%</td></tr><tr><td>Move/Shot Ratio</td><td id=m1_split>-% / -%</td></tr></tbody><caption style=caption-side:bottom>Click/hover on pitch to see xT levels.</caption></table></div></div><script type=text/javascript>var shots_data={0:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},1:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.0003615329,12:0,13:0,14:.0008361204,15:0},2:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:.0004125413,9:.0003314551,10:0,11:.0007426662,12:.0046811001,13:.0026041667,14:.0021978022,15:0},3:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:.0003853565,11:.0080681309,12:.0705734089,13:.1693121693,14:.1897233202,15:.083503055},4:{0:0,1:.0008084074,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:.0009242144,11:.0459770115,12:.1891891892,13:.3629764065,14:.4356060606,15:.412371134},5:{0:.0117340287,1:.0013648772,2:0,3:0,4:0,5:0,6:0,7:.0005275653,8:.0006837607,9:0,10:.0015625,11:.0714700755,12:.2575757576,13:.4704861111,14:.6374570447,15:.7988826816},6:{0:.0101596517,1:.0005279831,2:0,3:0,4:0,5:0,6:.0005461496,7:295858e-9,8:.0003469813,9:0,10:.0021691974,11:.0729225551,12:.2414231258,13:.4619205298,14:.6884422111,15:.7875647668},7:{0:.0023640662,1:.0009302326,2:0,3:0,4:0,5:0,6:0,7:0,8:.0004230118,9:0,10:.0004321521,11:.0482180294,12:.1620771046,13:.3158730159,14:.4770318021,15:.3036649215},8:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:.0006779661,11:.012406015,12:.0692921236,13:.1930541369,14:.1843891403,15:.08},9:{0:0,1:0,2:0,3:.0004957858,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.001003009,12:.0092307692,13:.015576324,14:.0097560976,15:.0037453184},10:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:.0011547344,14:0,15:0},11:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:.0022883295}},moves_data={0:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1,13:1,14:1,15:1},1:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:.9996384671,12:1,13:1,14:.9991638796,15:1},2:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:.9995874587,9:.9996685449,10:1,11:.9992573338,12:.9953188999,13:.9973958333,14:.9978021978,15:1},3:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:.9996146435,11:.9919318691,12:.9294265911,13:.8306878307,14:.8102766798,15:.916496945},4:{0:1,1:.9991915926,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:.9990757856,11:.9540229885,12:.8108108108,13:.6370235935,14:.5643939394,15:.587628866},5:{0:.9882659713,1:.9986351228,2:1,3:1,4:1,5:1,6:1,7:.9994724347,8:.9993162393,9:1,10:.9984375,11:.9285299245,12:.7424242424,13:.5295138889,14:.3625429553,15:.2011173184},6:{0:.9898403483,1:.9994720169,2:1,3:1,4:1,5:1,6:.9994538504,7:.999704142,8:.9996530187,9:1,10:.9978308026,11:.9270774449,12:.7585768742,13:.5380794702,14:.3115577889,15:.2124352332},7:{0:.9976359338,1:.9990697674,2:1,3:1,4:1,5:1,6:1,7:1,8:.9995769882,9:1,10:.9995678479,11:.9517819706,12:.8379228954,13:.6841269841,14:.5229681979,15:.6963350785},8:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:.9993220339,11:.987593985,12:.9307078764,13:.8069458631,14:.8156108597,15:.92},9:{0:1,1:1,2:1,3:.9995042142,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:.998996991,12:.9907692308,13:.984423676,14:.9902439024,15:.9962546816},10:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1,13:.9988452656,14:1,15:1},11:{0:1,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:1,9:1,10:1,11:1,12:1,13:1,14:1,15:.9977116705}},shot_threat={0:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},1:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},2:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},3:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:.0003853565,11:0,12:.0006301197,13:.003968254,14:.0079051383,15:.0020366599},4:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.0005473454,12:.0057915058,13:.0344827586,14:.0587121212,15:.0463917526},5:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.0005810575,12:.0113636364,13:.046875,14:.1494845361,15:.3407821229},6:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.0016958734,12:.0114358323,13:.0546357616,14:.149078727,15:.378238342},7:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:.001572327,12:.0047206924,13:.0333333333,14:.0971731449,15:.0471204188},8:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:997009e-9,13:.0081716037,14:.0147058824,15:.0048},9:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},10:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:0},11:{0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0,11:0,12:0,13:0,14:0,15:.0022883295}},model1_data={"(0, 0)":.0010137465,"(0, 1)":.0014895051,"(0, 2)":.0017626221,"(0, 3)":.0023059601,"(0, 4)":.0026353818,"(0, 5)":.0028199839,"(0, 6)":.0028492916,"(0, 7)":.0026168113,"(0, 8)":.002217744,"(0, 9)":.0020714449,"(0, 10)":.0015299613,"(0, 11)":.0010293822,"(1, 0)":.0015161562,"(1, 1)":.0019289599,"(1, 2)":.0025351159,"(1, 3)":.003045511,"(1, 4)":.003250135,"(1, 5)":.0034477526,"(1, 6)":.003396268,"(1, 7)":.0032063441,"(1, 8)":.0031317776,"(1, 9)":.0028102041,"(1, 10)":.0021905317,"(1, 11)":.0017080986,"(2, 0)":.0021175682,"(2, 1)":.0025149797,"(2, 2)":.0030222468,"(2, 3)":.0035329673,"(2, 4)":.0039894128,"(2, 5)":.0038556857,"(2, 6)":.0039813232,"(2, 7)":.0035536845,"(2, 8)":.0035300555,"(2, 9)":.0032798607,"(2, 10)":.0028241826,"(2, 11)":.0021125396,"(3, 0)":.0026094887,"(3, 1)":.0031064672,"(3, 2)":.003549767,"(3, 3)":.0037837206,"(3, 4)":.0039877092,"(3, 5)":.0041089269,"(3, 6)":.0043115078,"(3, 7)":.0041447367,"(3, 8)":.0040417086,"(3, 9)":.0038444172,"(3, 10)":.0033866494,"(3, 11)":.002897617,"(4, 0)":.0033123317,"(4, 1)":.0038301007,"(4, 2)":.0042168136,"(4, 3)":.0046272634,"(4, 4)":.0047786918,"(4, 5)":.005045642,"(4, 6)":.0050140999,"(4, 7)":.0049554767,"(4, 8)":.0047716339,"(4, 9)":.0044177651,"(4, 10)":.0041796994,"(4, 11)":.0035616395,"(5, 0)":.0040900792,"(5, 1)":.0045578511,"(5, 2)":.0050499939,"(5, 3)":.0055858327,"(5, 4)":.0057388079,"(5, 5)":.0060263929,"(5, 6)":.0059332262,"(5, 7)":.0059737272,"(5, 8)":.0057208161,"(5, 9)":.0054026688,"(5, 10)":.0049148352,"(5, 11)":.0042593728,"(6, 0)":.0050038546,"(6, 1)":.0057380969,"(6, 2)":.0063638844,"(6, 3)":.0065933246,"(6, 4)":.0069994267,"(6, 5)":.0074032792,"(6, 6)":.0072550547,"(6, 7)":.0071936238,"(6, 8)":.0070003556,"(6, 9)":.0066122338,"(6, 10)":.0060559912,"(6, 11)":.0053229156,"(7, 0)":.0061718503,"(7, 1)":.0071920251,"(7, 2)":.0075221016,"(7, 3)":.0083635022,"(7, 4)":.0084760088,"(7, 5)":.0080748633,"(7, 6)":.0084131445,"(7, 7)":.0086681695,"(7, 8)":.0084386981,"(7, 9)":.0081447163,"(7, 10)":.0074726151,"(7, 11)":.0065875607,"(8, 0)":.0076152284,"(8, 1)":.0086210005,"(8, 2)":.0091212267,"(8, 3)":.0095962695,"(8, 4)":.010310119,"(8, 5)":.010008555,"(8, 6)":.010251164,"(8, 7)":.010071763,"(8, 8)":.0098269147,"(8, 9)":.0094493929,"(8, 10)":.0087711833,"(8, 11)":.0079051101,"(9, 0)":.0091646005,"(9, 1)":.010392345,"(9, 2)":.011123219,"(9, 3)":.01153341,"(9, 4)":.012053684,"(9, 5)":.012393751,"(9, 6)":.01264773,"(9, 7)":.01181903,"(9, 8)":.011759386,"(9, 9)":.011308601,"(9, 10)":.010547638,"(9, 11)":.009656185,"(10, 0)":.011689067,"(10, 1)":.012980591,"(10, 2)":.014026294,"(10, 3)":.015220967,"(10, 4)":.015065975,"(10, 5)":.014949347,"(10, 6)":.015159744,"(10, 7)":.015215868,"(10, 8)":.015066177,"(10, 9)":.014426688,"(10, 10)":.013224333,"(10, 11)":.012247279,"(11, 0)":.014957486,"(11, 1)":.016691703,"(11, 2)":.01808703,"(11, 3)":.020823058,"(11, 4)":.019536792,"(11, 5)":.019820917,"(11, 6)":.021144477,"(11, 7)":.020520949,"(11, 8)":.019864464,"(11, 9)":.018670206,"(11, 10)":.016773026,"(11, 11)":.015052879,"(12, 0)":.017676854,"(12, 1)":.021262103,"(12, 2)":.024567025,"(12, 3)":.02505512,"(12, 4)":.02932236,"(12, 5)":.036461619,"(12, 6)":.03616001,"(12, 7)":.030362958,"(12, 8)":.025601018,"(12, 9)":.022497917,"(12, 10)":.020370325,"(12, 11)":.017643279,"(13, 0)":.018394377,"(13, 1)":.024579592,"(13, 2)":.028702271,"(13, 3)":.035148799,"(13, 4)":.070549955,"(13, 5)":.077001395,"(13, 6)":.084869248,"(13, 7)":.068978394,"(13, 8)":.038417632,"(13, 9)":.026263316,"(13, 10)":.022981516,"(13, 11)":.01989493,"(14, 0)":.018630421,"(14, 1)":.023152044,"(14, 2)":.033816759,"(14, 3)":.043170552,"(14, 4)":.099819404,"(14, 5)":.19022651,"(14, 6)":.18711254,"(14, 7)":.13180591,"(14, 8)":.05046763,"(14, 9)":.028164456,"(14, 10)":.020692096,"(14, 11)":.018745094,"(15, 0)":.018812558,"(15, 1)":.025382159,"(15, 2)":.030979529,"(15, 3)":.03959291,"(15, 4)":.091523037,"(15, 5)":.38259787,"(15, 6)":.42825719,"(15, 7)":.098388491,"(15, 8)":.029122451,"(15, 9)":.026837779,"(15, 10)":.025522446,"(15, 11)":.023181141};$(document).ready(function(){const p=500,f=360,e={top:0,right:0,bottom:0,left:0},j=p-e.left-e.right,b=f-e.top-e.bottom,t=d3.select("#model1_field").append("svg").attr("viewBox",`0 0  ${j+e.left+e.right} ${b+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");t.append("rect").attr("fill","#f1f1f1").attr("width",p).attr("height",f);const d=t.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(d,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const m="#6b6b6b",_=d.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),l=16,s=12,a=1050/l,h=680/s,r=[];for(var n,o,c,u,g,v,y,i=0;i<l;i++){let e=[];for(n=0;n<s;n++)e.push([i,n]);r.push(e)}g=_.selectAll().data(r).enter().append("g").attr("class","row"),o=(e,t)=>{let n=d3.select(e.target);n.style("stroke","red"),n.style("stroke-width",3);let o=model1_data[`(${t[0]}, ${t[1]})`],s=shot_threat[t[1]][t[0]],i=o-s;document.getElementById("m1_grid_no").innerText=t[0]+", "+t[1],document.getElementById("m1_xT").innerText=(model1_data[`(${t[0]}, ${t[1]})`]*100).toFixed(2)+"%",document.getElementById("m1_split").innerText=(moves_data[t[1]][t[0]]*100).toFixed(2)+"% / "+(shots_data[t[1]][t[0]]*100).toFixed(2)+"%",document.getElementById("m1_sT").innerText=(s*100).toFixed(2)+"%",document.getElementById("m1_mT").innerText=(i*100).toFixed(2)+"%"},v=(e)=>{let n=d3.select(e.target);n.style("stroke",m),n.style("stroke-width",.3)},u=e=>{let t=d3.scaleLinear().domain([0,.01,.03,.1,.5]).range(["rgba(255, 255, 255, 0.5)","rgba(138, 255, 104, 0.5)","rgba(80, 173, 52, 0.5)","rgba(38, 105, 18, 0.5)","rgba(22, 82, 4, 0.5)"]);return t(e)},y=g.selectAll().data(function(e){return e}).enter().append("rect").attr("class","square").attr("x",function(e){return e[0]*a}).attr("y",function(e){return(s-e[1]-1)*h}).attr("width",a).attr("height",h).style("fill",function(e){return u(model1_data[`(${e[0]}, ${e[1]})`])}).style("stroke",m).attr("stroke-width",.3).on("mouseover",o).on("mousemove",o).on("mouseleave",v),arrowPoints=[[0,0],[0,20],[20,10]],c=t.append("defs"),c.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),t.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),t.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),t.append("text").attr("x",250).attr("y",15).attr("text-anchor","middle").text("Base Model").attr("font-size","8pt"),t.append("text").attr("x",490).attr("y",350).attr("text-anchor","end").text("@sertalpbilal").style("fill","#006fa9").attr("font-size","6pt")})</script><p>Since we have expected threat ratings calculated for each grid, we can measure any event in data in terms of its contribution to offense.
For example, Lindelöf&rsquo;s pass from grid <code>[4,0]</code> to grid <code>[14,4]</code> changes goal scoring probability from 0.33% to 9.98% (+9.65% increase).
Or, Gündogan&rsquo;s cross from <code>[14,10]</code> to <code>[14,4]</code> changes it from 2.07% to 9.98% (+7.91% increase).</p><p>The part I was interested in Karun&rsquo;s original blog post was the difference in left and right side of the field.
It somehow makes sense for a specific team to use one side of the field more effectively, but other than that,
I think there is little explanation for the difference between $\mathrm{xT}$ of grid <code>[14,7]</code> (13.18%) and <code>[14,4]</code> (9.98%) besides noise.
If we had more samples, numbers probably would get closer and become almost symmetrical.
So, this is the point optimization could help with.
Assuming we have a noisy sample, we force expected threat levels to be symmetric or balanced and minimize resulting errors.</p><h2 id=handling-noise-with-error-minimization>Handling Noise with Error Minimization</h2><h3 id=part-1-symmetricity>Part 1: Symmetricity</h3><p>Our first change in the model will be making sure that $\mathrm{xT}$ levels of any symmetrical grids are equal to each other.
However, adding these equations to the linear system of equations will make the system infeasible.
Therefore, we will benefit from optimization to reduce the errors we will generate.
This is similar to how linear regression works, we minimize the total error.
For this purpose, we will add error term to each grid position.</p><p>There are a few ways to define what total error means (e.g. sum of squared errors), but let us keep the problem simple and assume we are trying to minimize sum of all error terms.
In order to measure the magnitude of the total, we need to minimize the absolute values of each error term.</p><p>Our error variable for grid $(x,y)$ will be $e_{x,y}$.
Now, we can write the objective function as
$$
\sum_{(x,y) \in G} |e_{xy}|
$$
Absolute value function $|e_{x,y}|$ is not linear, but it consists of two linear expressions: $e_{xy}$ and $-e_{xy}$.
We can introduce a new variable to represent absolute value, $a_{xy}$, and can write the problem now as a linear optimization model.</p><div class="alert alert-info" role=alert><b>Update (2021-03-26):</b> I have added an extra constraint to keep total error equal to 0.</div><p class=x-scroll>\begin{align}
\textrm{minimize: } \; & \sum_{(x,y) \in G} \textcolor{darkblue}{a_{x,y}} \\
\text{subject to: } \;
& \mathrm{xT}_{x,y} + \textcolor{darkblue}{e_{x,y}} = s_{x,y} \cdot g_{x,y} + m_{x,y} \cdot \sum_{(z,w) \in G} T_{(x,y)\to (z,w)} \cdot \mathrm{xT}_{z,w} \quad & \forall (x,y) \in G \\
& a_{xy} \geq e_{xy} & \quad \forall (x,y) \in G \\
& a_{xy} \geq -e_{xy} & \quad \forall (x,y) \in G \\
& \mathrm{xT}_{x,y} = \mathrm{xT}_{x,11-y} \quad & \forall (x,y) \in G \\
& \sum_{(x,y) \in G} e_{xy} = 0
\end{align}</p><p>We can write this model using sasoptpy as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>model <span style=color:#f92672>=</span> so<span style=color:#f92672>.</span>Model(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xThreatModel_sym&#39;</span>)
</span></span><span style=display:flex><span>indices <span style=color:#f92672>=</span> [(x,y) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(w) <span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(l)]
</span></span><span style=display:flex><span>xT <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xT&#39;</span>)
</span></span><span style=display:flex><span>err <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;error&#39;</span>)
</span></span><span style=display:flex><span>err_abs <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;error_abs&#39;</span>, lb<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>+</span> err[x,y] <span style=color:#f92672>==</span> shots<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> scores<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>+</span> moves<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> so<span style=color:#f92672>.</span>expr_sum(T<span style=color:#f92672>.</span>loc[(x,y),(z,w)] <span style=color:#f92672>*</span> xT[z,w] <span style=color:#66d9ef>for</span> (z,w) <span style=color:#f92672>in</span> indices) <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;relation&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (err_abs[x,y] <span style=color:#f92672>&gt;=</span> err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;abs_values1&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (err_abs[x,y] <span style=color:#f92672>&gt;=</span> <span style=color:#f92672>-</span>err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;abs_values2&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>==</span> xT[x, l<span style=color:#f92672>-</span>y<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;symm_con&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraint(so<span style=color:#f92672>.</span>expr_sum(err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;zero_error_total&#39;</span>)
</span></span><span style=display:flex><span>sum_err_abs <span style=color:#f92672>=</span> so<span style=color:#f92672>.</span>expr_sum(err_abs[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>set_objective(sum_err_abs, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;total_error&#39;</span>, sense<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;N&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>export_mps(filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;export.mps&#39;</span>)
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cbc export.mps solve solu solution.txt&#39;</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>system(command)
</span></span></code></pre></div><p>Solving this model gives an objective of <code>0.146</code> in 0.06 seconds.
So a total of 14.6% error is accumulating when we try to force symmetricity into model.
Hover/click on the grid locations to see how $\mathrm{xT}$ values look like:</p><div id=model2 class=row><div id=model2_field class="col-12 col-md-8"></div><div id=model2_info class="col-12 col-md-4"><table class="table table-sm table-hover" id=model2_table style=table-layout:fixed><thead><tr><th></th><th>Value</th></tr></thead><tbody><tr><td>Grid</td><td id=m2_grid_no>-</td></tr><tr><td>xT</td><td id=m2_xT>-%</td></tr><tr><td>Error (Adj.) Rate</td><td id=m2_err>-%</td></tr><tr><td>Move Threat</td><td id=m2_mT>-%</td></tr><tr><td>Shot Threat</td><td id=m2_sT>-%</td></tr><tr><td>Move/Shot Ratio</td><td id=m2_split>-% / -%</td></tr></tbody><caption style=caption-side:bottom>Click/hover on pitch to see xT levels.</caption></table></div></div><script type=text/javascript>var model2_data={"(0, 0)":.0010537164,"(0, 1)":.0015483621,"(0, 2)":.0020399461,"(0, 3)":.002367699,"(0, 4)":.0026635794,"(0, 5)":.0028628964,"(0, 6)":.0028628964,"(0, 7)":.0026635794,"(0, 8)":.002367699,"(0, 9)":.0020399461,"(0, 10)":.0015483621,"(0, 11)":.0010537164,"(1, 0)":.0016675666,"(1, 1)":.0021508951,"(1, 2)":.0027589027,"(1, 3)":.0031102643,"(1, 4)":.0032850754,"(1, 5)":.003458947,"(1, 6)":.003458947,"(1, 7)":.0032850754,"(1, 8)":.0031102643,"(1, 9)":.0027589027,"(1, 10)":.0021508951,"(1, 11)":.0016675666,"(2, 0)":.0021893912,"(2, 1)":.0027640301,"(2, 2)":.0032202668,"(2, 3)":.0035819395,"(2, 4)":.0039818355,"(2, 5)":.0039601749,"(2, 6)":.0039601749,"(2, 7)":.0039818355,"(2, 8)":.0035819395,"(2, 9)":.0032202668,"(2, 10)":.0027640301,"(2, 11)":.0021893912,"(3, 0)":.0028165869,"(3, 1)":.0032926665,"(3, 2)":.0036026907,"(3, 3)":.0038162997,"(3, 4)":.004084849,"(3, 5)":.0042790168,"(3, 6)":.0042790168,"(3, 7)":.004084849,"(3, 8)":.0038162997,"(3, 9)":.0036026907,"(3, 10)":.0032926665,"(3, 11)":.0028165869,"(4, 0)":.0034425481,"(4, 1)":.0040469001,"(4, 2)":.0042870686,"(4, 3)":.0046516162,"(4, 4)":.0048626534,"(4, 5)":.004991245,"(4, 6)":.004991245,"(4, 7)":.0048626534,"(4, 8)":.0046516162,"(4, 9)":.0042870686,"(4, 10)":.0040469001,"(4, 11)":.0034425481,"(5, 0)":.0041014554,"(5, 1)":.004731597,"(5, 2)":.0050475326,"(5, 3)":.0055592531,"(5, 4)":.0058343401,"(5, 5)":.005934126,"(5, 6)":.005934126,"(5, 7)":.0058343401,"(5, 8)":.0055592531,"(5, 9)":.0050475326,"(5, 10)":.004731597,"(5, 11)":.0041014554,"(6, 0)":.0051111597,"(6, 1)":.0058175733,"(6, 2)":.0063194117,"(6, 3)":.0065239923,"(6, 4)":.0070066562,"(6, 5)":.0072526008,"(6, 6)":.0072526008,"(6, 7)":.0070066562,"(6, 8)":.0065239923,"(6, 9)":.0063194117,"(6, 10)":.0058175733,"(6, 11)":.0051111597,"(7, 0)":.0061501404,"(7, 1)":.0071393022,"(7, 2)":.007441775,"(7, 3)":.0081927393,"(7, 4)":.0084456056,"(7, 5)":.007927271,"(7, 6)":.007927271,"(7, 7)":.0084456056,"(7, 8)":.0081927393,"(7, 9)":.007441775,"(7, 10)":.0071393022,"(7, 11)":.0061501404,"(8, 0)":.0075690757,"(8, 1)":.0084568682,"(8, 2)":.0090173637,"(8, 3)":.0094811494,"(8, 4)":.0098699813,"(8, 5)":.0098725331,"(8, 6)":.0098725331,"(8, 7)":.0098699813,"(8, 8)":.0094811494,"(8, 9)":.0090173637,"(8, 10)":.0084568682,"(8, 11)":.0075690757,"(9, 0)":.0090871868,"(9, 1)":.010267872,"(9, 2)":.011013782,"(9, 3)":.011560243,"(9, 4)":.011959163,"(9, 5)":.012579372,"(9, 6)":.012579372,"(9, 7)":.011959163,"(9, 8)":.011560243,"(9, 9)":.011013782,"(9, 10)":.010267872,"(9, 11)":.0090871868,"(10, 0)":.011583617,"(10, 1)":.012883658,"(10, 2)":.013904632,"(10, 3)":.014928127,"(10, 4)":.015098947,"(10, 5)":.015014389,"(10, 6)":.015014389,"(10, 7)":.015098947,"(10, 8)":.014928127,"(10, 9)":.013904632,"(10, 10)":.012883658,"(10, 11)":.011583617,"(11, 0)":.014837734,"(11, 1)":.016532677,"(11, 2)":.017987771,"(11, 3)":.019836772,"(11, 4)":.020427876,"(11, 5)":.019775419,"(11, 6)":.019775419,"(11, 7)":.020427876,"(11, 8)":.019836772,"(11, 9)":.017987771,"(11, 10)":.016532677,"(11, 11)":.014837734,"(12, 0)":.017762579,"(12, 1)":.020589015,"(12, 2)":.023042766,"(12, 3)":.02569414,"(12, 4)":.029827151,"(12, 5)":.036312957,"(12, 6)":.036312957,"(12, 7)":.029827151,"(12, 8)":.02569414,"(12, 9)":.023042766,"(12, 10)":.020589015,"(12, 11)":.017762579,"(13, 0)":.018361727,"(13, 1)":.023646317,"(13, 2)":.028983155,"(13, 3)":.038413039,"(13, 4)":.071209987,"(13, 5)":.08484851,"(13, 6)":.08484851,"(13, 7)":.071209987,"(13, 8)":.038413039,"(13, 9)":.028983155,"(13, 10)":.023646317,"(13, 11)":.018361727,"(14, 0)":.018912382,"(14, 1)":.023088795,"(14, 2)":.033990967,"(14, 3)":.04998685,"(14, 4)":.10012064,"(14, 5)":.19059158,"(14, 6)":.19059158,"(14, 7)":.10012064,"(14, 8)":.04998685,"(14, 9)":.033990967,"(14, 10)":.023088795,"(14, 11)":.018912382,"(15, 0)":.023149631,"(15, 1)":.025733934,"(15, 2)":.030494316,"(15, 3)":.039401753,"(15, 4)":.096433537,"(15, 5)":.39494357,"(15, 6)":.39494357,"(15, 7)":.096433537,"(15, 8)":.039401753,"(15, 9)":.030494316,"(15, 10)":.025733934,"(15, 11)":.023149631},model2_error={"(0, 0)":0,"(0, 1)":0,"(0, 2)":-.0002099968,"(0, 3)":0,"(0, 4)":0,"(0, 5)":-.243126e-4,"(0, 6)":0,"(0, 7)":-.506619e-4,"(0, 8)":-151915e-9,"(0, 9)":0,"(0, 10)":-.349168e-4,"(0, 11)":-.406448e-4,"(1, 0)":-.947277e-4,"(1, 1)":-.0001404713,"(1, 2)":-.0001359727,"(1, 3)":.2606e-6,"(1, 4)":0,"(1, 5)":0,"(1, 6)":-.649311e-4,"(1, 7)":-.846822e-4,"(1, 8)":-62e-9,"(1, 9)":0,"(1, 10)":0,"(1, 11)":0,"(2, 0)":0,"(2, 1)":-.0001598094,"(2, 2)":-.0001214467,"(2, 3)":0,"(2, 4)":0,"(2, 5)":-.0001132186,"(2, 6)":0,"(2, 7)":-.0004529573,"(2, 8)":-.975052e-4,"(2, 9)":0,"(2, 10)":0,"(2, 11)":-.0001193719,"(3, 0)":-.0001283618,"(3, 1)":-.0001099637,"(3, 2)":0,"(3, 3)":0,"(3, 4)":-86808e-9,"(3, 5)":-.0001698314,"(3, 6)":0,"(3, 7)":0,"(3, 8)":.0001364564,"(3, 9)":.0001408714,"(3, 10)":0,"(3, 11)":0,"(4, 0)":-.751447e-4,"(4, 1)":-.0001555447,"(4, 2)":-.394152e-4,"(4, 3)":-.161805e-4,"(4, 4)":-95036e-9,"(4, 5)":.4628e-6,"(4, 6)":-.348305e-4,"(4, 7)":0,"(4, 8)":0,"(4, 9)":0,"(4, 10)":0,"(4, 11)":0,"(5, 0)":.250997e-4,"(5, 1)":-.0001444545,"(5, 2)":0,"(5, 3)":0,"(5, 4)":-156888e-9,"(5, 5)":0,"(5, 6)":-.0001151669,"(5, 7)":0,"(5, 8)":-.124806e-4,"(5, 9)":163902e-9,"(5, 10)":0,"(5, 11)":0,"(6, 0)":-.945719e-4,"(6, 1)":-.0001067636,"(6, 2)":0,"(6, 3)":0,"(6, 4)":-109373e-9,"(6, 5)":0,"(6, 6)":-.0001613164,"(6, 7)":0,"(6, 8)":241954e-9,"(6, 9)":.479492e-4,"(6, 10)":0,"(6, 11)":0,"(7, 0)":0,"(7, 1)":0,"(7, 2)":0,"(7, 3)":.702756e-4,"(7, 4)":-.0001055479,"(7, 5)":0,"(7, 6)":.0002840828,"(7, 7)":0,"(7, 8)":0,"(7, 9)":.0004024107,"(7, 10)":.490958e-4,"(7, 11)":.0001830663,"(8, 0)":0,"(8, 1)":.924996e-4,"(8, 2)":0,"(8, 3)":0,"(8, 4)":.0003009335,"(8, 5)":0,"(8, 6)":.0002055361,"(8, 7)":0,"(8, 8)":.946873e-4,"(8, 9)":.0001398518,"(8, 10)":0,"(8, 11)":.363467e-4,"(9, 0)":0,"(9, 1)":38507e-9,"(9, 2)":0,"(9, 3)":-.0001083707,"(9, 4)":0,"(9, 5)":-.0002679614,"(9, 6)":0,"(9, 7)":-.0002891022,"(9, 8)":0,"(9, 9)":.478507e-4,"(9, 10)":0,"(9, 11)":.0002597383,"(10, 0)":0,"(10, 1)":0,"(10, 2)":0,"(10, 3)":.0002109179,"(10, 4)":-.929043e-4,"(10, 5)":-.0001693188,"(10, 6)":0,"(10, 7)":0,"(10, 8)":0,"(10, 9)":.0003674333,"(10, 10)":.0001223266,"(10, 11)":.0004290589,"(11, 0)":0,"(11, 1)":0,"(11, 2)":0,"(11, 3)":.0009624878,"(11, 4)":-.0008387475,"(11, 5)":0,"(11, 6)":.00129216,"(11, 7)":0,"(11, 8)":0,"(11, 9)":.0006945084,"(11, 10)":.0001764496,"(11, 11)":.0001494504,"(12, 0)":-.0002059562,"(12, 1)":.0005141413,"(12, 2)":.001470133,"(12, 3)":-.0002094388,"(12, 4)":0,"(12, 5)":.0003112953,"(12, 6)":0,"(12, 7)":.0003879266,"(12, 8)":0,"(12, 9)":0,"(12, 10)":0,"(12, 11)":0,"(13, 0)":0,"(13, 1)":.0007906701,"(13, 2)":0,"(13, 3)":-.0024486404,"(13, 4)":0,"(13, 5)":-.0071442375,"(13, 6)":0,"(13, 7)":-.0036672657,"(13, 8)":0,"(13, 9)":-.0018782393,"(13, 10)":0,"(13, 11)":.0016739539,"(14, 0)":-.732246e-4,"(14, 1)":0,"(14, 2)":0,"(14, 3)":-.0063079608,"(14, 4)":0,"(14, 5)":0,"(14, 6)":-.0042316342,"(14, 7)":.029606562,"(14, 8)":0,"(14, 9)":-.005184347,"(14, 10)":-.0018833572,"(14, 11)":0,"(15, 0)":-.0039917148,"(15, 1)":-.67542e-5,"(15, 2)":0,"(15, 3)":0,"(15, 4)":-.0045501185,"(15, 5)":-.011966763,"(15, 6)":.031058238,"(15, 7)":0,"(15, 8)":-.01023487,"(15, 9)":-.0034133407,"(15, 10)":0,"(15, 11)":0};$(document).ready(function(){const p=500,f=360,e={top:0,right:0,bottom:0,left:0},j=p-e.left-e.right,b=f-e.top-e.bottom,t=d3.select("#model2_field").append("svg").attr("viewBox",`0 0  ${j+e.left+e.right} ${b+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");t.append("rect").attr("fill","#f1f1f1").attr("width",p).attr("height",f);const d=t.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(d,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const m="#6b6b6b",_=d.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),l=16,s=12,a=1050/l,h=680/s,r=[];for(var n,o,c,u,g,v,y,i=0;i<l;i++){let e=[];for(n=0;n<s;n++)e.push([i,n]);r.push(e)}g=_.selectAll().data(r).enter().append("g").attr("class","row"),o=(e,t)=>{let n=d3.select(e.target);n.style("stroke","red"),n.style("stroke-width",3);let i=model2_data[`(${t[0]}, ${t[1]})`],s=model2_error[`(${t[0]}, ${t[1]})`],o=shot_threat[t[1]][t[0]],a=i+s-o;document.getElementById("m2_grid_no").innerText=t[0]+", "+t[1],document.getElementById("m2_xT").innerText=(model2_data[`(${t[0]}, ${t[1]})`]*100).toFixed(2)+"%",document.getElementById("m2_err").innerText=(s*100).toFixed(2)+"%",document.getElementById("m2_split").innerText=(moves_data[t[1]][t[0]]*100).toFixed(2)+"% / "+(shots_data[t[1]][t[0]]*100).toFixed(2)+"%",document.getElementById("m2_sT").innerText=(o*100).toFixed(2)+"%",document.getElementById("m2_mT").innerText=(a*100).toFixed(2)+"%"},v=(e)=>{let n=d3.select(e.target);n.style("stroke",m),n.style("stroke-width",.3)},u=e=>{let t=d3.scaleLinear().domain([0,.01,.03,.1,.5]).range(["rgba(255, 255, 255, 0.5)","rgba(138, 255, 104, 0.5)","rgba(80, 173, 52, 0.5)","rgba(38, 105, 18, 0.5)","rgba(22, 82, 4, 0.5)"]);return t(e)},y=g.selectAll().data(function(e){return e}).enter().append("rect").attr("class","square").attr("x",function(e){return e[0]*a}).attr("y",function(e){return(s-e[1]-1)*h}).attr("width",a).attr("height",h).style("fill",function(e){return u(model2_data[`(${e[0]}, ${e[1]})`])}).style("stroke",m).attr("stroke-width",.3).on("mouseover",o).on("mousemove",o).on("mouseleave",v),arrowPoints=[[0,0],[0,20],[20,10]],c=t.append("defs"),c.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),t.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),t.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),t.append("text").attr("x",250).attr("y",15).attr("text-anchor","middle").text("Symmetric Model").attr("font-size","8pt"),t.append("text").attr("x",490).attr("y",350).attr("text-anchor","end").text("@sertalpbilal").style("fill","#006fa9").attr("font-size","6pt")})</script><p>You will notice that expected threat of grid <code>[14,7]</code> and <code>[14,4]</code> are equal now: 9.84%.
We have assigned 2.97% error rate for grid <code>[14,7]</code>, meaning we reduced the final expected threat level of this grid by this amount.</p><p>Note that, instead of forcing hard symmetricity, we could have identified a range on how much two symmetric grids could be away from each other.
For example, we could write
$$
\mathrm{xT}_{x,11-y} - r \leq \mathrm{xT}_{x,y} \leq \mathrm{xT}_{x,11-y} + r
$$
where $r$ is a relatively small percentage, say 1%.
It might be expected to have slightly asymmetrical $\mathrm{xT}$ values due higher number of right-footed players.
Regardless, such a correction could be especially handy when working with limited amount of data.</p><p>The final issue I will mention here is the weird behavior around grid <code>[15,9]</code> and <code>[15,8]</code>.
Notice that, our $\mathrm{xT}$ level drops from 2.88% to 2.75% even though we get closer to the goal.
A similar issue exists in base model between grid <code>[13,10]</code> (2.30%) and <code>[14,10]</code> (2.07%).
I think this is mainly due to lack of instances that originates at these locations.
So, our next step will be enforcing a non-decreasing pattern to have consistent values.</p><h3 id=part-2-consistency>Part 2: Consistency</h3><p>On top of the symmetrical model, our final model will feature the consistency of $\textrm{xT}$ values.
As we get closer to goal, we can make sure that $\textrm{xT}$ values follow a non-decreasing pattern.</p><p>One way to satify this consistency is to force expected threat of grid $(x,y)$ to be greater than $(z,y)$ (notice that it is the same row) if $(x,y)$ is closer to the goal.
Similarly, we can force expected threat of grid $(x,y)$ to be greater than $(x,w)$ if $(x,y)$ is closer to the goal.</p><p>We add two new constraints and get the following model:</p><p class=x-scroll>\begin{align}
\textrm{minimize: } \; & \sum_{(x,y) \in G} a_{x,y} \\
\text{subject to: } \;
& ... \\
& \mathrm{xT}_{x,y} \geq \mathrm{xT}_{z,w} \qquad \forall (x,y) \in G, \forall (z,w) \in G: d(x,y) \lt d(z,w) \text{ and } x=z \\
& \mathrm{xT}_{x,y} \geq \mathrm{xT}_{z,w} \qquad \forall (x,y) \in G, \forall (z,w) \in G: d(x,y) \lt d(z,w) \text{ and } y=w
\end{align}</p><p>where $d_{x,y}$ is the distance of grid $(x,y)$ to the goal.</p><p>We can write this model using sasoptpy as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>model <span style=color:#f92672>=</span> so<span style=color:#f92672>.</span>Model(name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xThreatModel_sym_inc&#39;</span>)
</span></span><span style=display:flex><span>indices <span style=color:#f92672>=</span> [(x,y) <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(w) <span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(l)]
</span></span><span style=display:flex><span>xT <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;xT&#39;</span>)
</span></span><span style=display:flex><span>err <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;error&#39;</span>)
</span></span><span style=display:flex><span>err_abs <span style=color:#f92672>=</span> model<span style=color:#f92672>.</span>add_variables(indices, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;error_abs&#39;</span>, lb<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>+</span> err[x,y] <span style=color:#f92672>==</span> shots<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> scores<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>+</span> moves<span style=color:#f92672>.</span>loc[x,y] <span style=color:#f92672>*</span> so<span style=color:#f92672>.</span>expr_sum(T<span style=color:#f92672>.</span>loc[(x,y),(z,w)] <span style=color:#f92672>*</span> xT[z,w] <span style=color:#66d9ef>for</span> (z,w) <span style=color:#f92672>in</span> indices) <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;relation&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (err_abs[x,y] <span style=color:#f92672>&gt;=</span> err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;abs_values1&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (err_abs[x,y] <span style=color:#f92672>&gt;=</span> <span style=color:#f92672>-</span>err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;abs_values2&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>==</span> xT[x, l<span style=color:#f92672>-</span>y<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;symm_con&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraint(so<span style=color:#f92672>.</span>expr_sum(err[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices) <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;zero_error_total&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>&gt;=</span> xT[z, w] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices <span style=color:#66d9ef>for</span> (z,w) <span style=color:#f92672>in</span> indices <span style=color:#66d9ef>if</span> dist(x,y) <span style=color:#f92672>&lt;</span> dist(z,w) <span style=color:#f92672>and</span> x<span style=color:#f92672>==</span>z), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;same_row&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>add_constraints(
</span></span><span style=display:flex><span>    (xT[x,y] <span style=color:#f92672>&gt;=</span> xT[z, w] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices <span style=color:#66d9ef>for</span> (z,w) <span style=color:#f92672>in</span> indices <span style=color:#66d9ef>if</span> dist(x,y) <span style=color:#f92672>&lt;</span> dist(z,w) <span style=color:#f92672>and</span> y<span style=color:#f92672>==</span>w), name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;same_col&#39;</span>)
</span></span><span style=display:flex><span>sum_err_abs <span style=color:#f92672>=</span> so<span style=color:#f92672>.</span>expr_sum(err_abs[x,y] <span style=color:#66d9ef>for</span> (x,y) <span style=color:#f92672>in</span> indices)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>set_objective(sum_err_abs, name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;total_error&#39;</span>, sense<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;N&#39;</span>)
</span></span><span style=display:flex><span>model<span style=color:#f92672>.</span>export_mps(filename<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;export.mps&#39;</span>)
</span></span><span style=display:flex><span>command <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;cbc export.mps presolve off solve solu solution.txt&#39;</span>
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>system(command)
</span></span></code></pre></div><p>This problem takes less than a second to solve with an objective of 15.4% error in total.</p><p>Finally, we get our final $\mathrm{xT}$ values:</p><div id=model3 class=row><div id=model3_field class="col-12 col-md-8"></div><div id=model3_info class="col-12 col-md-4"><table class="table table-sm table-hover" id=model3_table style=table-layout:fixed><thead><tr><th></th><th>Value</th></tr></thead><tbody><tr><td>Grid</td><td id=m3_grid_no>-</td></tr><tr><td>xT</td><td id=m3_xT>-%</td></tr><tr><td>Error (Adj.) Rate</td><td id=m3_err>-%</td></tr><tr><td>Move Threat</td><td id=m3_mT>-%</td></tr><tr><td>Shot Threat</td><td id=m3_sT>-%</td></tr><tr><td>Move/Shot Ratio</td><td id=m3_split>-% / -%</td></tr></tbody><caption style=caption-side:bottom>Click/hover on pitch to see xT levels.</caption></table></div></div><script type=text/javascript>var model3_data={"(0, 0)":.0009687587,"(0, 1)":.0014240984,"(0, 2)":.0018763042,"(0, 3)":.0021760979,"(0, 4)":.0024532596,"(0, 5)":.0026333693,"(0, 6)":.0026333693,"(0, 7)":.0024532596,"(0, 8)":.0021760979,"(0, 9)":.0018763042,"(0, 10)":.0014240984,"(0, 11)":.0009687587,"(1, 0)":.0015365121,"(1, 1)":.0019790055,"(1, 2)":.0025373776,"(1, 3)":.0028628962,"(1, 4)":.0030204472,"(1, 5)":.003182638,"(1, 6)":.003182638,"(1, 7)":.0030204472,"(1, 8)":.0028628962,"(1, 9)":.0025373776,"(1, 10)":.0019790055,"(1, 11)":.0015365121,"(2, 0)":.0020156832,"(2, 1)":.0025431769,"(2, 2)":.0029625774,"(2, 3)":.0032919789,"(2, 4)":.0036401261,"(2, 5)":.0036401261,"(2, 6)":.0036401261,"(2, 7)":.0036401261,"(2, 8)":.0032919789,"(2, 9)":.0029625774,"(2, 10)":.0025431769,"(2, 11)":.0020156832,"(3, 0)":.0025923764,"(3, 1)":.0030270977,"(3, 2)":.0033120844,"(3, 3)":.0035098652,"(3, 4)":.0037552959,"(3, 5)":.003862156,"(3, 6)":.003862156,"(3, 7)":.0037552959,"(3, 8)":.0035098652,"(3, 9)":.0033120844,"(3, 10)":.0030270977,"(3, 11)":.0025923764,"(4, 0)":.0031664255,"(4, 1)":.0037225475,"(4, 2)":.0039439485,"(4, 3)":.0042788185,"(4, 4)":.0044773845,"(4, 5)":.0046013718,"(4, 6)":.0046013718,"(4, 7)":.0044773845,"(4, 8)":.0042788185,"(4, 9)":.0039439485,"(4, 10)":.0037225475,"(4, 11)":.0031664255,"(5, 0)":.0037710867,"(5, 1)":.0043529186,"(5, 2)":.0046472411,"(5, 3)":.0051175604,"(5, 4)":.0053816157,"(5, 5)":.0054785519,"(5, 6)":.0054785519,"(5, 7)":.0053816157,"(5, 8)":.0051175604,"(5, 9)":.0046472411,"(5, 10)":.0043529186,"(5, 11)":.0037710867,"(6, 0)":.0046179072,"(6, 1)":.0053653332,"(6, 2)":.0058296045,"(6, 3)":.0060142338,"(6, 4)":.0063648558,"(6, 5)":.0067225394,"(6, 6)":.0067225394,"(6, 7)":.0063648558,"(6, 8)":.0060142338,"(6, 9)":.0058296045,"(6, 10)":.0053653332,"(6, 11)":.0046179072,"(7, 0)":.0056704034,"(7, 1)":.0065876547,"(7, 2)":.0068756043,"(7, 3)":.0075642551,"(7, 4)":.0076254358,"(7, 5)":.0076254355,"(7, 6)":.0076254355,"(7, 7)":.0076254358,"(7, 8)":.0075642551,"(7, 9)":.0068756043,"(7, 10)":.0065876547,"(7, 11)":.0056704034,"(8, 0)":.0069902587,"(8, 1)":.0078121937,"(8, 2)":.0083298131,"(8, 3)":.0087574876,"(8, 4)":.0091370544,"(8, 5)":.009339213,"(8, 6)":.009339213,"(8, 7)":.0091370544,"(8, 8)":.0087574876,"(8, 9)":.0083298131,"(8, 10)":.0078121937,"(8, 11)":.0069902587,"(9, 0)":.0084057865,"(9, 1)":.0094897079,"(9, 2)":.010189372,"(9, 3)":.010564627,"(9, 4)":.011028053,"(9, 5)":.011625962,"(9, 6)":.011625962,"(9, 7)":.011028053,"(9, 8)":.010564627,"(9, 9)":.010189372,"(9, 10)":.0094897079,"(9, 11)":.0084057865,"(10, 0)":.010729743,"(10, 1)":.011922138,"(10, 2)":.012843255,"(10, 3)":.013763959,"(10, 4)":.013840972,"(10, 5)":.013840972,"(10, 6)":.013840972,"(10, 7)":.013840972,"(10, 8)":.013763959,"(10, 9)":.012843255,"(10, 10)":.011922138,"(10, 11)":.010729743,"(11, 0)":.013798014,"(11, 1)":.015327688,"(11, 2)":.01666621,"(11, 3)":.018234825,"(11, 4)":.01826423,"(11, 5)":.01826423,"(11, 6)":.01826423,"(11, 7)":.01826423,"(11, 8)":.018234825,"(11, 9)":.01666621,"(11, 10)":.015327688,"(11, 11)":.013798014,"(12, 0)":.016384206,"(12, 1)":.019140404,"(12, 2)":.021415075,"(12, 3)":.02356495,"(12, 4)":.027895612,"(12, 5)":.034470055,"(12, 6)":.034470055,"(12, 7)":.027895612,"(12, 8)":.02356495,"(12, 9)":.021415075,"(12, 10)":.019140404,"(12, 11)":.016384206,"(13, 0)":.017239673,"(13, 1)":.022192208,"(13, 2)":.024795415,"(13, 3)":.033800012,"(13, 4)":.065061041,"(13, 5)":.075473768,"(13, 6)":.075473768,"(13, 7)":.065061041,"(13, 8)":.033800012,"(13, 9)":.024795415,"(13, 10)":.022192208,"(13, 11)":.017239673,"(14, 0)":.017944726,"(14, 1)":.022192208,"(14, 2)":.030232058,"(14, 3)":.040206773,"(14, 4)":.09840608,"(14, 5)":.18591057,"(14, 6)":.18591057,"(14, 7)":.09840608,"(14, 8)":.040206773,"(14, 9)":.030232058,"(14, 10)":.022192208,"(14, 11)":.017944726,"(15, 0)":.022744935,"(15, 1)":.025313401,"(15, 2)":.030232058,"(15, 3)":.040206773,"(15, 4)":.09840608,"(15, 5)":.42917127,"(15, 6)":.42917127,"(15, 7)":.09840608,"(15, 8)":.040206773,"(15, 9)":.030232058,"(15, 10)":.025313401,"(15, 11)":.022744935},model3_error={"(0, 0)":0,"(0, 1)":0,"(0, 2)":-194127e-9,"(0, 3)":0,"(0, 4)":0,"(0, 5)":-.221204e-4,"(0, 6)":0,"(0, 7)":-.493535e-4,"(0, 8)":-.0001371597,"(0, 9)":0,"(0, 10)":-.310387e-4,"(0, 11)":-36346e-9,"(1, 0)":-88816e-9,"(1, 1)":-.0001283906,"(1, 2)":-.0001231525,"(1, 3)":0,"(1, 4)":0,"(1, 5)":0,"(1, 6)":-.611269e-4,"(1, 7)":-.784245e-4,"(1, 8)":-.27027e-5,"(1, 9)":0,"(1, 10)":0,"(1, 11)":0,"(2, 0)":0,"(2, 1)":-.0001486196,"(2, 2)":-.0001128037,"(2, 3)":0,"(2, 4)":.288056e-4,"(2, 5)":-.0001032244,"(2, 6)":0,"(2, 7)":-.0003966087,"(2, 8)":-.865927e-4,"(2, 9)":0,"(2, 10)":0,"(2, 11)":-11117e-8,"(3, 0)":-.0001188874,"(3, 1)":-.0001000442,"(3, 2)":0,"(3, 3)":0,"(3, 4)":-.772361e-4,"(3, 5)":-.862491e-4,"(3, 6)":.696779e-4,"(3, 7)":0,"(3, 8)":.0001234513,"(3, 9)":.0001288972,"(3, 10)":0,"(3, 11)":0,"(4, 0)":-.670207e-4,"(4, 1)":-.0001438636,"(4, 2)":-.373605e-4,"(4, 3)":-.118184e-4,"(4, 4)":-.860289e-4,"(4, 5)":0,"(4, 6)":-.387783e-4,"(4, 7)":0,"(4, 8)":0,"(4, 9)":0,"(4, 10)":0,"(4, 11)":0,"(5, 0)":.241868e-4,"(5, 1)":-129397e-9,"(5, 2)":0,"(5, 3)":0,"(5, 4)":-.0001458464,"(5, 5)":0,"(5, 6)":-.0001059225,"(5, 7)":0,"(5, 8)":-.89522e-5,"(5, 9)":.0001509412,"(5, 10)":0,"(5, 11)":0,"(6, 0)":0,"(6, 1)":-.0001010076,"(6, 2)":0,"(6, 3)":0,"(6, 4)":0,"(6, 5)":0,"(6, 6)":-.0001543608,"(6, 7)":109049e-9,"(6, 8)":228291e-9,"(6, 9)":.387298e-4,"(6, 10)":0,"(6, 11)":.853701e-4,"(7, 0)":0,"(7, 1)":0,"(7, 2)":0,"(7, 3)":.722499e-4,"(7, 4)":.925466e-4,"(7, 5)":-.0002667989,"(7, 6)":0,"(7, 7)":.0001939637,"(7, 8)":0,"(7, 9)":.0003772871,"(7, 10)":.454416e-4,"(7, 11)":.0001692907,"(8, 0)":0,"(8, 1)":.846392e-4,"(8, 2)":0,"(8, 3)":0,"(8, 4)":.0002766864,"(8, 5)":-.0001986702,"(8, 6)":0,"(8, 7)":0,"(8, 8)":.960798e-4,"(8, 9)":.0001290566,"(8, 10)":0,"(8, 11)":.385691e-4,"(9, 0)":0,"(9, 1)":.358431e-4,"(9, 2)":0,"(9, 3)":0,"(9, 4)":0,"(9, 5)":-.0002722566,"(9, 6)":0,"(9, 7)":-.0002599635,"(9, 8)":.0001079452,"(9, 9)":.267933e-4,"(9, 10)":0,"(9, 11)":.0002409196,"(10, 0)":0,"(10, 1)":0,"(10, 2)":0,"(10, 3)":.0002240087,"(10, 4)":-.340074e-4,"(10, 5)":-15765e-8,"(10, 6)":0,"(10, 7)":.597516e-4,"(10, 8)":0,"(10, 9)":.0003311671,"(10, 10)":.948638e-4,"(10, 11)":.0003805232,"(11, 0)":0,"(11, 1)":0,"(11, 2)":0,"(11, 3)":.0009838274,"(11, 4)":-.0002390364,"(11, 5)":0,"(11, 6)":.0012419133,"(11, 7)":.0006858614,"(11, 8)":0,"(11, 9)":.0006014359,"(11, 10)":135851e-9,"(11, 11)":.0001074567,"(12, 0)":0,"(12, 1)":.0006411521,"(12, 2)":.0014529455,"(12, 3)":0,"(12, 4)":0,"(12, 5)":192037e-9,"(12, 6)":0,"(12, 7)":.0002412587,"(12, 8)":.0002012272,"(12, 9)":0,"(12, 10)":0,"(12, 11)":.0001277448,"(13, 0)":0,"(13, 1)":.0009694659,"(13, 2)":.0024846207,"(13, 3)":0,"(13, 4)":.0042117338,"(13, 5)":0,"(13, 6)":.0073165141,"(13, 7)":0,"(13, 8)":.0021346691,"(13, 9)":0,"(13, 10)":0,"(13, 11)":.0016157273,"(14, 0)":-.507549e-4,"(14, 1)":-.0002012632,"(14, 2)":.002573765,"(14, 3)":.0024770729,"(14, 4)":.0007629156,"(14, 5)":.0037533307,"(14, 6)":0,"(14, 7)":.030443069,"(14, 8)":.0080315844,"(14, 9)":-.0026419775,"(14, 10)":-.0021712142,"(14, 11)":0,"(15, 0)":-.0041283356,"(15, 1)":0,"(15, 2)":0,"(15, 3)":0,"(15, 4)":-.0046053677,"(15, 5)":-.043916517,"(15, 6)":0,"(15, 7)":0,"(15, 8)":-.01135576,"(15, 9)":-.0035185522,"(15, 10)":-.0001095298,"(15, 11)":0};$(document).ready(function(){const p=500,f=360,e={top:0,right:0,bottom:0,left:0},j=p-e.left-e.right,b=f-e.top-e.bottom,t=d3.select("#model3_field").append("svg").attr("viewBox",`0 0  ${j+e.left+e.right} ${b+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");t.append("rect").attr("fill","#f1f1f1").attr("width",p).attr("height",f);const d=t.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(d,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const m="#6b6b6b",_=d.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),l=16,s=12,a=1050/l,h=680/s,r=[];for(var n,o,c,u,g,v,y,i=0;i<l;i++){let e=[];for(n=0;n<s;n++)e.push([i,n]);r.push(e)}g=_.selectAll().data(r).enter().append("g").attr("class","row"),o=(e,t)=>{let n=d3.select(e.target);n.style("stroke","red"),n.style("stroke-width",3);let i=model3_data[`(${t[0]}, ${t[1]})`],s=model3_error[`(${t[0]}, ${t[1]})`],o=shot_threat[t[1]][t[0]],a=i+s-o;document.getElementById("m3_grid_no").innerText=t[0]+", "+t[1],document.getElementById("m3_xT").innerText=(model3_data[`(${t[0]}, ${t[1]})`]*100).toFixed(2)+"%",document.getElementById("m3_err").innerText=(s*100).toFixed(2)+"%",document.getElementById("m3_split").innerText=(moves_data[t[1]][t[0]]*100).toFixed(2)+"% / "+(shots_data[t[1]][t[0]]*100).toFixed(2)+"%",document.getElementById("m3_sT").innerText=(o*100).toFixed(2)+"%",document.getElementById("m3_mT").innerText=(a*100).toFixed(2)+"%"},v=(e)=>{let n=d3.select(e.target);n.style("stroke",m),n.style("stroke-width",.3)},u=e=>{let t=d3.scaleLinear().domain([0,.01,.03,.1,.5]).range(["rgba(255, 255, 255, 0.5)","rgba(138, 255, 104, 0.5)","rgba(80, 173, 52, 0.5)","rgba(38, 105, 18, 0.5)","rgba(22, 82, 4, 0.5)"]);return t(e)},y=g.selectAll().data(function(e){return e}).enter().append("rect").attr("class","square").attr("x",function(e){return e[0]*a}).attr("y",function(e){return(s-e[1]-1)*h}).attr("width",a).attr("height",h).style("fill",function(e){return u(model3_data[`(${e[0]}, ${e[1]})`])}).style("stroke",m).attr("stroke-width",.3).on("mouseover",o).on("mousemove",o).on("mouseleave",v),arrowPoints=[[0,0],[0,20],[20,10]],c=t.append("defs"),c.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),t.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),t.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),t.append("text").attr("x",250).attr("y",15).attr("text-anchor","middle").text("Non-decreasing Symmetric Model").attr("font-size","8pt"),t.append("text").attr("x",490).attr("y",350).attr("text-anchor","end").text("@sertalpbilal").style("fill","#006fa9").attr("font-size","6pt")})</script><p>Now expected threat values for</p><ul><li><code>[15,9]</code> is 3.02% (2.68% in base model, 3.02% in symmetric model)</li><li><code>[15,8]</code> is 4.02% (2.91% in base model, 3.94% in symmetric model)</li></ul><p>and their symmetric counterparts:</p><ul><li><code>[15,2]</code> is 3.02% (3.10% in base model, 3.05% in symmetric model)</li><li><code>[15,3]</code> is 4.02% (3.96% in base model, 3.94% in symmetric model)</li></ul><h2 id=comparison-and-recap>Comparison and Recap</h2><p>You can find all 3 values of $\mathrm{xT}$ values below. Hover/click on a grid to see the corresponding levels.</p><div id=comparison class=row><div id=cmp_field class="col-12 col-md-8"></div><div id=cmp_info class="col-12 col-md-4"><table class="table table-sm table-hover" id=cmp_table style=table-layout:fixed><thead><tr><th></th><th>Value</th></tr></thead><tbody><tr><td>Grid</td><td id=cmp_grid_no>-</td></tr><tr><td>xT (Base)</td><td id=cmp_xT1>-%</td></tr><tr><td>xT (Symm)</td><td id=cmp_xT2>-%</td></tr><tr><td>xT (ND-Symm)</td><td id=cmp_xT3>-%</td></tr></tbody><caption style=caption-side:bottom>Click/hover on pitch to see xT levels.</caption></table></div></div><script type=text/javascript>$(document).ready(function(){const p=500,u=360,e={top:0,right:0,bottom:0,left:0},_=p-e.left-e.right,f=u-e.top-e.bottom,n=d3.select("#cmp_field").append("svg").attr("viewBox",`0 0  ${_+e.left+e.right} ${f+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");n.append("rect").attr("fill","#f1f1f1").attr("width",p).attr("height",u);const v=n.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(v,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const y="#6b6b6b",w=v.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),h=16,c=12,a=1050/h,o=680/c,j=[];for(var t,i,r,d,m,g,b,s=0;s<h;s++){let e=[];for(t=0;t<c;t++)e.push([s,t]);j.push(e)}g=j.flat();const l=g.map(e=>({index:e,values:[{key:"m1",value:model1_data[`(${e[0]}, ${e[1]})`]},{key:"m2",value:model2_data[`(${e[0]}, ${e[1]})`]},{key:"m3",value:model3_data[`(${e[0]}, ${e[1]})`]}]}));console.log(l),b=(e,t)=>{let n=d3.select(e.target);n.style("fill","#82f1ff"),document.getElementById("cmp_grid_no").innerText=t.index[0]+", "+t.index[1],document.getElementById("cmp_xT1").innerText=(t.values[0].value*100).toFixed(2)+"%",document.getElementById("cmp_xT2").innerText=(t.values[1].value*100).toFixed(2)+"%",document.getElementById("cmp_xT3").innerText=(t.values[2].value*100).toFixed(2)+"%"},d=e=>{let t=d3.select(e.target);t.style("fill","#ffffff00")};for(i of l)r=w.append("svg").attr("width",a).attr("height",o).attr("x",e=>i.index[0]*a).attr("y",e=>(c-i.index[1]-1)*o),r.append("rect").datum(i).attr("class","square").attr("x",0).attr("y",0).attr("width",a).attr("height",o).style("fill","#ffffff00").style("stroke",y).attr("stroke-width",.3).on("mouseover",b).on("mouseleave",d),s=d3.scaleBand().range([1,a-1]).domain(["m1","m2","m3"]).padding(.2),t=d3.scaleLinear().domain([-.05,.5]).range([o-1,1]),r.selectAll().data(i.values).enter().append("rect").attr("x",function(e){return s(e.key)}).attr("y",function(e){return t(e.value)}).attr("width",s.bandwidth()).attr("height",function(e){return f-t(e.value)}).attr("fill","#69b3a2").attr("opacity",.7).style("pointer-events","none");arrowPoints=[[0,0],[0,20],[20,10]],m=n.append("defs"),m.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),n.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),n.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),n.append("text").attr("x",250).attr("y",15).attr("text-anchor","middle").text("Comparison of xT Values").attr("font-size","8pt"),n.append("text").attr("x",490).attr("y",350).attr("text-anchor","end").text("@sertalpbilal").style("fill","#006fa9").attr("font-size","6pt")})</script><p>Now, we have a perfectly symmetrical and non-decreasing model on our hands.
Our final model manages to fix both issues we tackled:</p><ul><li>Possession of the ball on grids <code>[14,4]</code> and <code>[14,7]</code> are equal to each other</li><li>Passing from grid <code>[13,10]</code> to <code>[14,10]</code> does not decrease threat level</li></ul><p>So, to recap, expected threat is a method for assessing the value of having the ball possession for attacking team in pitch locations.
The detail of the data dictates how accurate the model can get.
When working with limited data, it is important to reduce the noise.
We can use optimization modeling to ensure the final model is valid in terms of defined performance measures, like symmetricity.
This is a simplified take on how to include optimization into these type of analysis.
I hope it is inspiring in terms of tackling similar issues.</p><p>If you were wondering here are the contribution of each moves that is shown at the beginning of the post:</p><div id=final_visual class=row><div id=final_field class="col-12 col-md-6"></div><div id=final_table class="col-12 col-md-6"><table class="table table-sm table-hover" id=table2><thead><tr><th>Name</th><th>Action</th><th>From</th><th>To</th><th>xT Contr. (Base)</th><th>xT Contr. (ND-Symm)</th></tr></thead><tbody></tbody></table></div></div><script type=text/javascript>initial_data.forEach(e=>{let t=e.bins[1],n=e.bins[0],s=((model1_data[`(${t[0]}, ${t[1]})`]-model1_data[`(${n[0]}, ${n[1]})`])*100).toFixed(2)+"%",o=((model3_data[`(${t[0]}, ${t[1]})`]-model3_data[`(${n[0]}, ${n[1]})`])*100).toFixed(2)+"%";debugger;e.action!="shot"&&$("#table2 tbody").append(`<tr class="table2-row" style="cursor: pointer" data-from="${e.from}" data-to="${e.to}"><td>${e.name}</td><td>${e.action}</td><td>${e.bins[0]}</td><td>${e.bins[1]}</td><td>${s}</td><td>${o}</td></tr>`)}),$(document).on("mouseover",".table2-row",function(e){let t=e.currentTarget.dataset.from.split(",").map(e=>parseFloat(e)),n=e.currentTarget.dataset.to.split(",").map(e=>parseFloat(e));addLine2(t,n)})</script><script type=text/javascript>$(document).ready(function(){const u=500,h=360,e={top:0,right:0,bottom:0,left:0},v=u-e.left-e.right,g=h-e.top-e.bottom,t=d3.select("#final_field").append("svg").attr("viewBox",`0 0  ${v+e.left+e.right} ${g+e.top+e.bottom}`).attr("class","pull-center").style("display","block").style("margin-bottom","10px");t.append("rect").attr("fill","#f1f1f1").attr("width",u).attr("height",h);const m=t.append("svg").attr("viewBox","0 0 1150 780").attr("preserveAspectRatio","xMidYMin meet");draw_field(m,{opacity:1,fieldColor:"none",lineColor:"#6b6b6b"});const j="#6b6b6b",l=m.append("g").attr("transform","translate(50,50)").attr("width",1050).attr("height",680),d=16,n=12,i=1050/d,o=680/n,f=[];for(var s,a,r,p,b,c=0;c<d;c++){let e=[];for(s=0;s<n;s++)e.push([c,s]);f.push(e)}a=l.selectAll().data(f).enter().append("g").attr("class","row"),p=e=>{let t=d3.scaleLinear().domain([0,.01,.03,.1,.5]).range(["rgba(255, 255, 255, 0.5)","rgba(138, 255, 104, 0.5)","rgba(80, 173, 52, 0.5)","rgba(38, 105, 18, 0.5)","rgba(22, 82, 4, 0.5)"]);return t(e)},b=a.selectAll().data(function(e){return e}).enter().append("rect").attr("class","square").attr("x",function(e){return e[0]*i}).attr("y",function(e){return(n-e[1]-1)*o}).attr("width",i).attr("height",o).style("fill",function(e){return p(model3_data[`(${e[0]}, ${e[1]})`])}).style("stroke",j).attr("stroke-width",.3),a.selectAll().data(function(e){return e}).enter().append("text").attr("x",function(e){return e[0]*i+i/2}).attr("y",function(e){return(n-e[1]-1)*o+o/2}).attr("alignment-baseline","middle").attr("text-anchor","middle").attr("font-size","15pt").style("text-shadow","0px 0px 2px gray").style("opacity",.2).text(function(e){return e[0]+","+e[1]}).style("pointer-events","none"),arrowPoints=[[0,0],[0,20],[20,10]],r=t.append("defs"),r.append("marker").attr("id","arrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","black"),r.append("marker").attr("id","redarrow").attr("viewBox",[0,0,20,20]).attr("refX",20).attr("refY",10).attr("markerWidth",8).attr("markerHeight",8).attr("orient","auto-start-reverse").append("path").attr("d",d3.line()(arrowPoints)).attr("stroke","red").attr("fill","red"),t.append("line").attr("x1",200).attr("y1",335).attr("x2",300).attr("y2",335).attr("stroke","black").attr("marker-end","url(#arrow)").attr("fill","none"),t.append("text").attr("x",250).attr("y",350).attr("text-anchor","middle").text("Attack Direction").attr("font-size","8pt"),window.addLine2=(e,n)=>{d3.select("#action_line").remove(),console.log(t),l.append("line").attr("id","action_line").attr("x1",e[0]*10).attr("y1",680-e[1]*10).attr("x2",n[0]*10).attr("y2",680-n[1]*10).attr("stroke-width",4).attr("stroke","red").attr("marker-end","url(#redarrow)").attr("fill","none")}})</script><p>Compared to the base model, we identified that Mané&rsquo;s dribble might have a higher importance (0.61% to 1.80%).
Contribution of Traoré&rsquo;s pass, on the other hand, decreases slightly from 2.93% to 2.19%.</p><h2 id=future-work>Future Work</h2><p>One thing I mentioned but didn&rsquo;t cover in details is how the total error is defined.
When using sum of squared errors, the problem becomes an Quadratic Optimization instance and requires a different solver to solve.
We could take a further step and generalize the problem by trying to minimize the <em>p</em>-norm as
$$
\text{minimize: } \Vert e \Vert_{p} := \left ( \sum_{(x,y) \in G} |e_{x,y}|^{p} \right )^{1/p}
$$
In this post I used $p=1$ which gives absolute value function, and similarly we could have tried to minimize the maximum error using $p=\infty$.</p><p>A totally different direction for involving the optimization is generating $\mathrm{xT}$ values per team, and analyze/find best <em>n</em>-step plays.
This obviously requires more data, but assuming some grid connections are blocked by opponent defenders, optimization can find which play maximizes $\mathrm{xT}$ accumulation over next <em>n</em> moves.</p><p>If you are interested to work on any of these problems or have another idea, please reach out to me.
You can find my <a href=https://github.com/sertalpbilal/football_analytics/blob/main/notebooks/xT.ipynb target=_blank>Jupyter Notebook (Python) on GitHub</a> that includes data steps and all models I have generated here.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>FBref has a <a href=https://fbref.com/en/expected-goals-model-explained/ target=_blank>page on xG</a> if you would like to learn more about it.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Note that, similar (possession value) models are available in market, and recently discussed in <a href=https://statsbomb.com/2021/03/what-happened-at-statsbomb-evolve-360-data-quality-obv-and-more/ target=_blank>StatsBomb&rsquo;s 360 reveal</a>.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Field drawing is based on this <a href=https://bl.ocks.org/balders93/98ff5f77b82eea28f47c72e1e256286d target=_blank>Blocks page</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>Here $\mathrm{xT}_{x,y}$ depends on $\mathrm{xT}_{z,w}$ and vice versa. Therefore, we have a nested structure.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>We can think this as a Markov chain and $\mathrm{xT}$ as the steady-state probabilities.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></div><div class=col-md-3><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Search</h3></div><div class=panel-body><form action=//google.com/search method=get accept-charset=UTF-8 role=search><div class=input-group><input type=search name=q class=form-control placeholder=Search>
<input type=hidden name=sitesearch value=https://alpscode.com/>
<span class=input-group-btn><button type=submit class="btn btn-template-main"><i class="fas fa-search"></i></button></span></div></form></div></div><div class="panel panel-default sidebar-menu"><div class=panel-heading><h3 class=panel-title>Categories</h3></div><div class=panel-body><ul class="nav nav-pills nav-stacked"><li><a href=/categories/analytics>analytics (3)</a></li><li><a href=/categories/optimization>optimization (6)</a></li><li><a href=/categories/programming>programming (2)</a></li><li><a href=/categories/quick-tip>quick-tip (3)</a></li></ul></div></div><div class="panel sidebar-menu"><div class=panel-heading><h3 class=panel-title>Tags</h3></div><div class=panel-body><ul class=tag-cloud><li><a href=/tags/analytics><i class="fas fa-tags"></i> analytics</a></li><li><a href=/tags/api><i class="fas fa-tags"></i> api</a></li><li><a href=/tags/fantasy-premier-league><i class="fas fa-tags"></i> fantasy premier league</a></li><li><a href=/tags/fantasy-sports><i class="fas fa-tags"></i> fantasy sports</a></li><li><a href=/tags/fpl><i class="fas fa-tags"></i> fpl</a></li><li><a href=/tags/how-to><i class="fas fa-tags"></i> how-to</a></li><li><a href=/tags/latex><i class="fas fa-tags"></i> latex</a></li><li><a href=/tags/linux><i class="fas fa-tags"></i> linux</a></li><li><a href=/tags/machine-learning><i class="fas fa-tags"></i> machine learning</a></li><li><a href=/tags/math><i class="fas fa-tags"></i> math</a></li><li><a href=/tags/mathematics><i class="fas fa-tags"></i> mathematics</a></li><li><a href=/tags/optimization><i class="fas fa-tags"></i> optimization</a></li><li><a href=/tags/parsing><i class="fas fa-tags"></i> parsing</a></li><li><a href=/tags/predictive-modeling><i class="fas fa-tags"></i> predictive modeling</a></li><li><a href=/tags/python><i class="fas fa-tags"></i> python</a></li><li><a href=/tags/reddit><i class="fas fa-tags"></i> reddit</a></li><li><a href=/tags/rocket-league><i class="fas fa-tags"></i> rocket league</a></li><li><a href=/tags/script><i class="fas fa-tags"></i> script</a></li><li><a href=/tags/security><i class="fas fa-tags"></i> security</a></li><li><a href=/tags/soccer><i class="fas fa-tags"></i> soccer</a></li><li><a href=/tags/sports><i class="fas fa-tags"></i> sports</a></li><li><a href=/tags/web><i class="fas fa-tags"></i> web</a></li></ul></div></div></div></div></div></div><footer id=footer><div class=container><div class="col-md-4 col-sm-6"><h4>About</h4>AlpsCode is a technical blog about programming languages, tips, examples, and tech trends. Follow me at <a href=https://twitter.com/alpscode>Twitter</a> and <a href=https://github.com/alpscode>Github</a>.<hr class="hidden-md hidden-lg hidden-sm"></div><div class="col-md-4 col-sm-6"></div><div class="col-md-4 col-sm-6"><h4>Contact</h4><p>alpscode [at] gmail</p><p><a href=https://github.com/alpscode><i class='fa fa-2x fa-github'></i></a>
<a href=https://twitter.com/alpscode><i class='fa fa-2x fa-twitter'></i></a>
<a href=https://stackoverflow.com/users/10735543/alp-c><i class='fa fa-2x fa-stack-overflow'></i></a><hr class="hidden-md hidden-lg hidden-sm"></div></div></footer><div id=copyright><div class=container><div class=col-md-12><p class=pull-left><a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/><img alt="Creative Commons License" style=border-width:0 src=https://i.creativecommons.org/l/by-sa/4.0/88x31.png></a>&nbsp; &nbsp;This blog is licensed under a <a rel=license href=http://creativecommons.org/licenses/by-sa/4.0/>Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p><p class=pull-right>Template by <a href=http://bootstrapious.com/free-templates>Bootstrapious</a>.
Ported to Hugo by <a href=https://github.com/devcows/hugo-universal-theme>DevCows</a></p></div></div></div></div><script src=//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js integrity=sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa crossorigin=anonymous></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/waypoints/4.0.1/jquery.waypoints.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/Counter-Up/1.0/jquery.counterup.min.js></script><script src=//cdnjs.cloudflare.com/ajax/libs/jquery-parallax/1.1.3/jquery-parallax.js></script><script src=https://alpscode.com/js/gmaps.init.js></script><script src=https://alpscode.com/js/front.js></script><script src=https://alpscode.com/js/owl.carousel.min.js></script><script>var myLazyLoad=new LazyLoad({elements_selector:".lazy"})</script><script src=https://d3js.org/d3.v6.min.js></script></body></html>